import{d as ae,r,c as x,o as ue,a as M,b as i,e as t,m as y,p as P,g as k,n as _,u as j,q as re,l as ie,s as U,t as a,f as h,x as N,T as A,w as ce,v as de,F as S,h as T,y as V,z as ve,j as o,k as fe}from"./index-D1yyfS71.js";import{L as O}from"./vue3-datepicker-BHtIG-If.js";const pe={class:"p-6 font-inter"},me={class:"flex space-x-4 bg-[#F1EFFF] p-3 rounded-lg mb-4"},be={class:"filters-wrapper relative flex flex-wrap gap-3 mb-6"},ge={class:"relative"},we={class:"relative"},xe={class:"relative w-48"},ye={key:0,class:"course-dropdown absolute z-50 mt-2 w-full bg-white border border-purple-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"},ke=["onClick"],_e={class:"relative w-48"},he={key:0,class:"funding-dropdown absolute z-10 w-full mt-2 bg-white border rounded-lg shadow-md"},Ce=["onClick"],Fe={key:0,class:"text-[rgb(98,82,254)]"},De={class:"w-full border bg-white border-purple-200 rounded-lg overflow-hidden text-left"},Re={class:"px-4 py-2"},Ee={class:"px-4 py-2"},Pe={class:"px-4 py-2"},je={class:"px-4 py-2"},Se={class:"px-4 py-2"},Te={class:"mt-6 w-full rounded-xl overflow-hidden border border-[#E0D7FF]"},Ve={class:"bg-[#ECE9FF] px-6 py-4 text-sm font-semibold text-black"},Le={class:"bg-white px-6 py-4 text-sm flex justify-between items-center"},Be={class:"bg-[#ECE9FF] px-6 py-4 text-sm font-semibold flex justify-between items-center"},$e=ae({__name:"TotalRevenue",setup(ze){const q=re(),d=r([]),v=r(void 0),c=r(void 0),m=r(!1),b=r(!1),L=r(null),B=r(null),C=r({start:"",end:""}),f=r(!1),w=r(""),D=r(""),R=r([]),Y=x(()=>Array.from(new Set(R.value.map(s=>s.course))).filter(s=>s.toLowerCase().includes(D.value.toLowerCase())));function I(){f.value=!f.value}function G(s){w.value=s,f.value=!1}function F(s){return s.toLocaleDateString("ru-RU")}function H(s){if(m.value=!m.value,m.value){const e=s.target.getBoundingClientRect();C.value.start=`position: absolute; top: ${e.bottom+window.scrollY+5}px; left: ${e.left}px; z-index: 9999;`}}function J(s){if(b.value=!b.value,b.value){const e=s.target.getBoundingClientRect();C.value.end=`position: absolute; top: ${e.bottom+window.scrollY+5}px; left: ${e.left}px; z-index: 9999;`}}function K(){m.value=!1}function Q(){b.value=!1}ue(()=>{document.addEventListener("click",X),W()});async function W(){try{const[s,e]=await Promise.all([M.get("/api/students"),M.get("/api/courses")]),n=e.data;R.value=s.data.map(l=>{const u=n.find(z=>z.id===l.course_id||z.name===l.subject),p=l.last_payment_date||l.created_at||null;return{date:p?new Date(p).toLocaleDateString("ru-RU"):"–––",amount:(l.paid_amount||0).toLocaleString("ru-RU"),course:(u==null?void 0:u.name)||l.subject||"–––",student:l.full_name||"",payment:l.funding_source||""}})}catch(s){console.error("Ошибка при загрузке студентов или курсов:",s)}}function X(s){var u,p;const e=s.target;!((u=L.value)!=null&&u.contains(e))&&!e.closest(".start-picker-btn")&&(m.value=!1),!((p=B.value)!=null&&p.contains(e))&&!e.closest(".end-picker-btn")&&(b.value=!1);const n=document.querySelector(".course-dropdown");f.value&&n&&!n.contains(e)&&!e.closest(".filter-select")&&(f.value=!1);const l=document.querySelector(".funding-dropdown");g.value&&l&&!l.contains(e)&&!e.closest(".filter-select")&&(g.value=!1)}const Z=x(()=>v.value&&c.value?`${F(v.value)} - ${F(c.value)}`:"не выбран"),E=x(()=>{const s=c.value?new Date(c.value.getFullYear(),c.value.getMonth(),c.value.getDate()+1):null;return R.value.filter(e=>{const n=new Date(e.date.split(".").reverse().join("-")),l=(!v.value||n>=v.value)&&(!s||n<s),u=!w.value||e.course===w.value,p=d.value.length===0||d.value.includes(e.payment);return l&&u&&p})}),ee=x(()=>E.value.reduce((s,e)=>{const n=parseInt(e.amount.replace(/[^\d]/g,""),10);return s+(isNaN(n)?0:n)},0)),$=x(()=>ee.value.toLocaleString("ru-RU"));function te(){const s=V.json_to_sheet(E.value),e=V.book_new();V.book_append_sheet(e,s,"Отчёт"),ve(e,"Отчёт.xlsx")}const le=["Полная оплата","TechOrda","Скидка 30%","Скидка 70%","Внутренний грант"],g=r(!1);function se(){g.value=!g.value,f.value=!1,m.value=!1,b.value=!1}function oe(s){const e=d.value.indexOf(s);e===-1?d.value.push(s):d.value.splice(e,1)}function ne(){v.value=void 0,c.value=void 0,w.value="",d.value=[],f.value=!1,g.value=!1}return(s,e)=>{const n=ie("router-link");return o(),i("div",pe,[e[11]||(e[11]=t("h2",{class:"text-2xl font-bold mb-6"},"Общая выручка",-1)),t("div",me,[y(n,{to:"/finance/reports/total-revenue",class:_(["tab-button",{"tab-button-active":j(q).path==="/finance/reports/total-revenue"}])},{default:P(()=>e[3]||(e[3]=[k("Общая выручка")])),_:1,__:[3]},8,["class"]),y(n,{to:"/finance/reports/debts",class:"tab-button"},{default:P(()=>e[4]||(e[4]=[k("Задолженности")])),_:1,__:[4]}),y(n,{to:"/finance/reports/student-funding",class:"tab-button"},{default:P(()=>e[5]||(e[5]=[k("Финансирование студентов")])),_:1,__:[5]})]),t("div",be,[t("div",ge,[t("button",{onClick:H,class:"filter-select w-48 start-picker-btn"},a(v.value?F(v.value):"Начало периода"),1),(o(),U(A,{to:"body"},[m.value?(o(),i("div",{key:0,class:"datepicker-popup",style:N(C.value.start),ref_key:"startPickerRef",ref:L},[y(j(O),{modelValue:v.value,"onUpdate:modelValue":[e[0]||(e[0]=l=>v.value=l),K]},null,8,["modelValue"])],4)):h("",!0)]))]),t("div",we,[t("button",{onClick:J,class:"filter-select w-48 end-picker-btn"},a(c.value?F(c.value):"Конец периода"),1),(o(),U(A,{to:"body"},[b.value?(o(),i("div",{key:0,class:"datepicker-popup",style:N(C.value.end),ref_key:"endPickerRef",ref:B},[y(j(O),{modelValue:c.value,"onUpdate:modelValue":[e[1]||(e[1]=l=>c.value=l),Q]},null,8,["modelValue"])],4)):h("",!0)]))]),t("div",xe,[t("button",{onClick:I,class:"filter-select w-full flex justify-between items-center",type:"button"},[k(a(w.value||"Курс")+" ",1),(o(),i("svg",{class:_(["w-4 h-4 ml-2 transform transition-transform duration-200",f.value?"rotate-180":""]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},e[6]||(e[6]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)]),2))]),f.value?(o(),i("div",ye,[ce(t("input",{type:"text","onUpdate:modelValue":e[2]||(e[2]=l=>D.value=l),placeholder:"Поиск курса",class:"w-full px-3 py-2 text-sm border-b outline-none"},null,512),[[de,D.value]]),t("ul",null,[(o(!0),i(S,null,T(Y.value,(l,u)=>(o(),i("li",{key:u,onClick:p=>G(l),class:_(["cursor-pointer px-4 py-2 hover:bg-gray-100",{"text-[rgb(98,82,254)] font-medium":w.value===l}])},a(l),11,ke))),128))])])):h("",!0)]),t("div",_e,[t("button",{onClick:se,class:"filter-select w-full flex justify-between items-center",type:"button"},[k(a(d.value.length?d.value.join(", "):"Тип финансирования")+" ",1),(o(),i("svg",{class:_(["w-4 h-4 ml-2 transform transition-transform duration-200",g.value?"rotate-180":""]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},e[7]||(e[7]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)]),2))]),g.value?(o(),i("ul",he,[(o(),i(S,null,T(le,l=>t("li",{key:l,onClick:u=>oe(l),class:"cursor-pointer px-4 py-2 hover:bg-gray-100 flex justify-between items-center"},[t("span",{class:_({"text-[rgb(98,82,254)] font-medium":d.value.includes(l)})},a(l),3),d.value.includes(l)?(o(),i("span",Fe,"✔")):h("",!0)],8,Ce)),64))])):h("",!0)]),t("div",{class:"relative"},[t("button",{onClick:ne,class:"filter-select w-full flex justify-between items-center"}," Очистить фильтры ")])]),t("table",De,[e[8]||(e[8]=t("thead",{class:"bg-[#ECE9FF] text-sm font-semibold"},[t("tr",null,[t("th",{class:"px-4 py-2"},"Дата"),t("th",{class:"px-4 py-2"},"Оплачено (тг)"),t("th",{class:"px-4 py-2"},"Курс"),t("th",{class:"px-4 py-2"},"Студент"),t("th",{class:"px-4 py-2"},"Оплата")])],-1)),t("tbody",null,[(o(!0),i(S,null,T(E.value,(l,u)=>(o(),i("tr",{class:"border-t",key:u},[t("td",Re,a(l.date),1),t("td",Ee,a(l.amount),1),t("td",Pe,a(l.course),1),t("td",je,a(l.student),1),t("td",Se,a(l.payment),1)]))),128))])]),t("div",Te,[t("div",Ve,"Период "+a(Z.value),1),t("div",Le,[e[9]||(e[9]=t("div",null,"Выручка",-1)),t("div",null,a($.value)+" тг",1)]),t("div",Be,[e[10]||(e[10]=t("div",null,"Общая выручка",-1)),t("div",null,a($.value)+" тг",1)])]),t("div",{class:"mt-4 flex justify-end"},[t("button",{onClick:te,class:"download-btn"},"Сохранить в Excel")])])}}}),Ne=fe($e,[["__scopeId","data-v-2d8f0c2d"]]);export{Ne as default};
