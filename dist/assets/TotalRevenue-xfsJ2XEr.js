import{d as ie,r as a,c as x,o as ce,a as z,e as i,f as t,w as N,v as A,p as y,q as S,h as _,n as k,u as L,s as de,m as ve,x as O,t as r,g as h,y as q,T as Y,F as V,i as T,z as B,A as pe,k as o,l as fe}from"./index-CfeF8dzU.js";import{_ as me}from"./search-CKZYpkUj.js";import{L as I}from"./vue3-datepicker-mIggi6md.js";const be={class:"p-6 font-inter"},ge={class:"flex items-center justify-between mb-6"},we={class:"search-wrapper"},xe={class:"flex space-x-4 bg-[#F1EFFF] p-3 rounded-lg mb-4"},ye={class:"filters-wrapper relative flex flex-wrap gap-3 mb-6"},_e={class:"relative"},ke={class:"relative"},he={class:"relative w-48"},Ce={key:0,class:"course-dropdown absolute z-50 mt-2 w-full bg-white border border-purple-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"},Fe=["onClick"],De={class:"relative w-48"},Re={key:0,class:"funding-dropdown absolute z-10 w-full mt-2 bg-white border rounded-lg shadow-md"},Ee=["onClick"],Pe={key:0,class:"text-[rgb(98,82,254)]"},je={class:"w-full border bg-white border-purple-200 rounded-lg overflow-hidden text-left"},Se={class:"px-4 py-2"},Le={class:"px-4 py-2"},Ve={class:"px-4 py-2"},Te={class:"px-4 py-2"},Be={class:"px-4 py-2"},Me={class:"mt-6 w-full rounded-xl overflow-hidden border border-[#E0D7FF]"},Ue={class:"bg-[#ECE9FF] px-6 py-4 text-sm font-semibold text-black"},$e={class:"bg-white px-6 py-4 text-sm flex justify-between items-center"},ze={class:"bg-[#ECE9FF] px-6 py-4 text-sm font-semibold flex justify-between items-center"},Ne=ie({__name:"TotalRevenue",setup(Ae){const G=de(),d=a([]),v=a(void 0),c=a(void 0),m=a(!1),b=a(!1),M=a(null),U=a(null),C=a({start:"",end:""}),p=a(!1),w=a(""),R=a(""),E=a([]),P=a(""),H=x(()=>Array.from(new Set(E.value.map(l=>l.course))).filter(l=>l.toLowerCase().includes(R.value.toLowerCase())));function J(){p.value=!p.value}function K(l){w.value=l,p.value=!1}function F(l){return l.toLocaleDateString("ru-RU")}function Q(l){if(m.value=!m.value,m.value){const e=l.target.getBoundingClientRect();C.value.start=`position: absolute; top: ${e.bottom+window.scrollY+5}px; left: ${e.left}px; z-index: 9999;`}}function W(l){if(b.value=!b.value,b.value){const e=l.target.getBoundingClientRect();C.value.end=`position: absolute; top: ${e.bottom+window.scrollY+5}px; left: ${e.left}px; z-index: 9999;`}}function X(){m.value=!1}function Z(){b.value=!1}ce(()=>{document.addEventListener("click",te),ee()});async function ee(){try{const[l,e]=await Promise.all([z.get("/api/students"),z.get("/api/courses")]),n=e.data;E.value=l.data.map(s=>{const u=n.find(D=>D.id===s.course_id||D.name===s.subject),f=s.last_payment_date||s.created_at||null;return{date:f?new Date(f).toLocaleDateString("ru-RU"):"–––",amount:(s.paid_amount||0).toLocaleString("ru-RU"),course:(u==null?void 0:u.name)||s.subject||"–––",student:s.full_name||"",payment:s.funding_source||""}})}catch(l){console.error("Ошибка при загрузке студентов или курсов:",l)}}function te(l){var u,f;const e=l.target;!((u=M.value)!=null&&u.contains(e))&&!e.closest(".start-picker-btn")&&(m.value=!1),!((f=U.value)!=null&&f.contains(e))&&!e.closest(".end-picker-btn")&&(b.value=!1);const n=document.querySelector(".course-dropdown");p.value&&n&&!n.contains(e)&&!e.closest(".filter-select")&&(p.value=!1);const s=document.querySelector(".funding-dropdown");g.value&&s&&!s.contains(e)&&!e.closest(".filter-select")&&(g.value=!1)}const se=x(()=>v.value&&c.value?`${F(v.value)} - ${F(c.value)}`:"не выбран"),j=x(()=>{const l=c.value?new Date(c.value.getFullYear(),c.value.getMonth(),c.value.getDate()+1):null;return E.value.filter(e=>{const n=new Date(e.date.split(".").reverse().join("-")),s=(!v.value||n>=v.value)&&(!l||n<l),u=!w.value||e.course===w.value,f=d.value.length===0||d.value.includes(e.payment),D=e.student.toLowerCase().includes(P.value.toLowerCase());return s&&u&&f&&D})}),le=x(()=>j.value.reduce((l,e)=>{const n=parseInt(e.amount.replace(/[^\d]/g,""),10);return l+(isNaN(n)?0:n)},0)),$=x(()=>le.value.toLocaleString("ru-RU"));function oe(){const l=B.json_to_sheet(j.value),e=B.book_new();B.book_append_sheet(e,l,"Отчёт"),pe(e,"Отчёт.xlsx")}const ne=["Полная оплата","TechOrda","Скидка 30%","Скидка 70%","Внутренний грант"],g=a(!1);function ae(){g.value=!g.value,p.value=!1,m.value=!1,b.value=!1}function re(l){const e=d.value.indexOf(l);e===-1?d.value.push(l):d.value.splice(e,1)}function ue(){v.value=void 0,c.value=void 0,w.value="",d.value=[],p.value=!1,g.value=!1}return(l,e)=>{const n=ve("router-link");return o(),i("div",be,[t("div",ge,[e[5]||(e[5]=t("h2",{class:"text-2xl font-bold"},"Общая выручка",-1)),t("div",we,[e[4]||(e[4]=t("img",{src:me,class:"search-icon"},null,-1)),N(t("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>P.value=s),type:"text",placeholder:"Поиск",class:"search-input"},null,512),[[A,P.value]])])]),t("div",xe,[y(n,{to:"/finance/reports/total-revenue",class:k(["tab-button",{"tab-button-active":L(G).path==="/finance/reports/total-revenue"}])},{default:S(()=>e[6]||(e[6]=[_("Общая выручка")])),_:1,__:[6]},8,["class"]),y(n,{to:"/finance/reports/debts",class:"tab-button"},{default:S(()=>e[7]||(e[7]=[_("Задолженности")])),_:1,__:[7]}),y(n,{to:"/finance/reports/student-funding",class:"tab-button"},{default:S(()=>e[8]||(e[8]=[_("Финансирование студентов")])),_:1,__:[8]})]),t("div",ye,[t("div",_e,[t("button",{onClick:Q,class:"filter-select w-48 start-picker-btn"},r(v.value?F(v.value):"Начало периода"),1),(o(),O(Y,{to:"body"},[m.value?(o(),i("div",{key:0,class:"datepicker-popup",style:q(C.value.start),ref_key:"startPickerRef",ref:M},[y(L(I),{modelValue:v.value,"onUpdate:modelValue":[e[1]||(e[1]=s=>v.value=s),X]},null,8,["modelValue"])],4)):h("",!0)]))]),t("div",ke,[t("button",{onClick:W,class:"filter-select w-48 end-picker-btn"},r(c.value?F(c.value):"Конец периода"),1),(o(),O(Y,{to:"body"},[b.value?(o(),i("div",{key:0,class:"datepicker-popup",style:q(C.value.end),ref_key:"endPickerRef",ref:U},[y(L(I),{modelValue:c.value,"onUpdate:modelValue":[e[2]||(e[2]=s=>c.value=s),Z]},null,8,["modelValue"])],4)):h("",!0)]))]),t("div",he,[t("button",{onClick:J,class:"filter-select w-full flex justify-between items-center",type:"button"},[_(r(w.value||"Курс")+" ",1),(o(),i("svg",{class:k(["w-4 h-4 ml-2 transform transition-transform duration-200",p.value?"rotate-180":""]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},e[9]||(e[9]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)]),2))]),p.value?(o(),i("div",Ce,[N(t("input",{type:"text","onUpdate:modelValue":e[3]||(e[3]=s=>R.value=s),placeholder:"Поиск курса",class:"w-full px-3 py-2 text-sm border-b outline-none"},null,512),[[A,R.value]]),t("ul",null,[(o(!0),i(V,null,T(H.value,(s,u)=>(o(),i("li",{key:u,onClick:f=>K(s),class:k(["cursor-pointer px-4 py-2 hover:bg-gray-100",{"text-[rgb(98,82,254)] font-medium":w.value===s}])},r(s),11,Fe))),128))])])):h("",!0)]),t("div",De,[t("button",{onClick:ae,class:"filter-select w-full flex justify-between items-center",type:"button"},[_(r(d.value.length?d.value.join(", "):"Тип финансирования")+" ",1),(o(),i("svg",{class:k(["w-4 h-4 ml-2 transform transition-transform duration-200",g.value?"rotate-180":""]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},e[10]||(e[10]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)]),2))]),g.value?(o(),i("ul",Re,[(o(),i(V,null,T(ne,s=>t("li",{key:s,onClick:u=>re(s),class:"cursor-pointer px-4 py-2 hover:bg-gray-100 flex justify-between items-center"},[t("span",{class:k({"text-[rgb(98,82,254)] font-medium":d.value.includes(s)})},r(s),3),d.value.includes(s)?(o(),i("span",Pe,"✔")):h("",!0)],8,Ee)),64))])):h("",!0)]),t("div",{class:"relative"},[t("button",{onClick:ue,class:"filter-select w-full flex justify-between items-center"}," Очистить фильтры ")])]),t("table",je,[e[11]||(e[11]=t("thead",{class:"bg-[#ECE9FF] text-sm font-semibold"},[t("tr",null,[t("th",{class:"px-4 py-2"},"Дата"),t("th",{class:"px-4 py-2"},"Оплачено (тг)"),t("th",{class:"px-4 py-2"},"Курс"),t("th",{class:"px-4 py-2"},"Студент"),t("th",{class:"px-4 py-2"},"Оплата")])],-1)),t("tbody",null,[(o(!0),i(V,null,T(j.value,(s,u)=>(o(),i("tr",{class:"border-t",key:u},[t("td",Se,r(s.date),1),t("td",Le,r(s.amount),1),t("td",Ve,r(s.course),1),t("td",Te,r(s.student),1),t("td",Be,r(s.payment),1)]))),128))])]),t("div",Me,[t("div",Ue,"Период "+r(se.value),1),t("div",$e,[e[12]||(e[12]=t("div",null,"Выручка",-1)),t("div",null,r($.value)+" тг",1)]),t("div",ze,[e[13]||(e[13]=t("div",null,"Общая выручка",-1)),t("div",null,r($.value)+" тг",1)])]),t("div",{class:"mt-4 flex justify-end"},[t("button",{onClick:oe,class:"download-btn"},"Сохранить в Excel")])])}}}),Ie=fe(Ne,[["__scopeId","data-v-d9341f61"]]);export{Ie as default};
