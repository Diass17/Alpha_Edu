import{_ as Z,r as n,o as ee,a as I,A as te,c as x,k as se,b,d as r,e as t,l as y,m as P,h as D,s as M,t as o,f as R,x as Y,u as q,T as O,n as S,F as le,i as oe,y as U,z as ae}from"./index-CaRyJ1xY.js";import{L as G}from"./vue3-datepicker-B6RZCzX-.js";const ne={class:"p-6 font-inter"},re={class:"flex space-x-4 bg-[#F1EFFF] p-3 rounded-lg mb-4"},ie={class:"filters-wrapper relative flex flex-wrap gap-3 mb-6"},ue={class:"relative"},de={class:"relative"},ce={class:"relative w-40 status-dropdown"},pe={key:0,class:"absolute z-50 mt-2 w-full bg-white border border-purple-200 rounded-lg shadow-lg overflow-hidden"},fe={class:"w-full bg-white border border-purple-200 rounded-lg overflow-hidden text-left mt-6"},ve={class:"px-4 py-2"},me={class:"w-6 h-6 rounded-md bg-[#F1ECFF] text-[rgb(98,82,254)] text-xs font-semibold flex items-center justify-center"},be={class:"px-4 py-2"},xe={class:"px-4 py-2"},ye={class:"px-4 py-2"},we={class:"px-4 py-2"},ge={class:"px-4 py-2"},ke={class:"mt-6 w-full rounded-xl overflow-hidden border border-[#E0D7FF]"},_e={class:"bg-[#ECE9FF] px-6 py-4 text-sm font-semibold text-black"},he={class:"bg-white px-6 py-4 text-sm flex justify-between border-b border-gray-200/60"},De={class:"bg-white px-6 py-4 text-sm flex justify-between border-b border-gray-200/60"},Se={class:"bg-white px-6 py-4 text-sm flex justify-between border-b border-gray-200/60"},Ce={class:"bg-[#ECE9FF] px-6 py-4 text-sm font-semibold flex justify-between"},Fe={__name:"Debts",setup(Ee){const c=n(null),p=n(null),f=n(!1),v=n(!1),w=n({start:"",end:""}),L=n(null),V=n(null),j=n([]);ee(async()=>{document.addEventListener("click",N);try{const e=(await I.get("http://localhost:3000/reports/debts")).data,a=await Promise.all(e.map(async s=>{let u="Не оплачен",C="-";if(s.amount_remaining===0)u="Оплачен";else try{const _=(await I.get(`http://localhost:3000/api/students/${s.id}/payment-schedule`)).data.paymentSchedule;if(Array.isArray(_)&&_.length>0){_.every(d=>d.paid)&&(u="Оплачен");const F=_.filter(d=>d.date).sort((d,h)=>new Date(d.date)-new Date(h.date));if(F.length>0){const d=F.find(E=>!E.paid),h=[...F].reverse().find(E=>E.paid);d?C=new Date(d.date).toLocaleDateString("ru-RU"):h&&(C=new Date(h.date).toLocaleDateString("ru-RU"))}}}catch(T){console.warn(`Не удалось получить график студента ID ${s.id}`,T)}return{id:s.id,student:s.full_name,amount:s.amount_remaining,paidAmount:s.paid_amount||0,paymentDate:C,status:u,comment:""}}));j.value=a.filter(s=>s.amount>0)}catch(l){console.error("Ошибка при загрузке задолженностей:",l)}}),te(()=>{document.removeEventListener("click",N)});const g=x(()=>{let l=[...j.value];return m.value&&(l=l.filter(e=>e.status===m.value)),l.sort((e,a)=>e.id-a.id)});function $(l){m.value=l,i.value=!1}const A=x(()=>g.value.reduce((l,e)=>l+(e.amount||0),0)),B=x(()=>g.value.reduce((l,e)=>l+(e.paidAmount||0),0)),z=x(()=>A.value-B.value),H=x(()=>c.value&&p.value?`${k(c.value)} - ${k(p.value)}`:"не выбран"),k=l=>new Date(l).toLocaleDateString("ru-RU");function J(l){if(f.value=!f.value,f.value){v.value=!1;const e=l.target.getBoundingClientRect();w.value.start=`position: absolute; top: ${e.bottom+window.scrollY+5}px; left: ${e.left}px; z-index: 9999;`}}function K(l){if(v.value=!v.value,v.value){f.value=!1;const e=l.target.getBoundingClientRect();w.value.end=`position: absolute; top: ${e.bottom+window.scrollY+5}px; left: ${e.left}px; z-index: 9999;`}}function Q(){i.value=!i.value,f.value=!1,v.value=!1}const W=()=>{const l=g.value.map(s=>({Студент:s.student,Сумма:s.amount,Статус:s.status,Комментарий:s.comment})),e=U.json_to_sheet(l),a=U.book_new();U.book_append_sheet(a,e,"Задолженности"),ae(a,"Задолженности.xlsx")},m=n(""),i=n(!1);function X(){c.value=null,p.value=null,m.value="",i.value=!1}function N(l){var s,u;const e=l.target;!((s=L.value)!=null&&s.contains(e))&&!e.closest(".start-picker-btn")&&(f.value=!1),!((u=V.value)!=null&&u.contains(e))&&!e.closest(".end-picker-btn")&&(v.value=!1);const a=document.querySelector(".status-dropdown");i.value&&a&&!a.contains(e)&&!e.closest(".filter-select")&&(i.value=!1)}return(l,e)=>{const a=se("router-link");return r(),b("div",ne,[e[13]||(e[13]=t("h2",{class:"text-2xl font-bold mb-6"},"Задолженности",-1)),t("div",re,[y(a,{to:"/finance/reports/total-revenue",class:"tab-button"},{default:P(()=>e[4]||(e[4]=[D("Общая выручка")])),_:1,__:[4]}),y(a,{to:"/finance/reports/debts",class:"tab-button-active"},{default:P(()=>e[5]||(e[5]=[D("Задолженности")])),_:1,__:[5]}),y(a,{to:"/finance/reports/student-funding",class:"tab-button"},{default:P(()=>e[6]||(e[6]=[D("Финансирование студентов")])),_:1,__:[6]})]),t("div",ie,[t("div",ue,[t("button",{onClick:J,class:"filter-select w-48 start-picker-btn"},o(c.value?k(c.value):"Начало периода"),1),(r(),M(O,{to:"body"},[f.value?(r(),b("div",{key:0,class:"datepicker-popup",style:Y(w.value.start),ref_key:"startPickerRef",ref:L},[y(q(G),{modelValue:c.value,"onUpdate:modelValue":[e[0]||(e[0]=s=>c.value=s),l.closeStartPicker]},null,8,["modelValue","onUpdate:modelValue"])],4)):R("",!0)]))]),t("div",de,[t("button",{onClick:K,class:"filter-select w-48 end-picker-btn"},o(p.value?k(p.value):"Конец периода"),1),(r(),M(O,{to:"body"},[v.value?(r(),b("div",{key:0,class:"datepicker-popup",style:Y(w.value.end),ref_key:"endPickerRef",ref:V},[y(q(G),{modelValue:p.value,"onUpdate:modelValue":[e[1]||(e[1]=s=>p.value=s),l.closeEndPicker]},null,8,["modelValue","onUpdate:modelValue"])],4)):R("",!0)]))]),t("div",ce,[t("button",{onClick:Q,class:"filter-select w-full flex justify-between items-center",type:"button"},[D(o(m.value||"Статус")+" ",1),(r(),b("svg",{class:S(["w-4 h-4 ml-2 transform transition-transform duration-200",i.value?"rotate-180":""]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},e[7]||(e[7]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)]),2))]),i.value?(r(),b("ul",pe,[t("li",{onClick:e[2]||(e[2]=s=>$("Оплачен")),class:S(["cursor-pointer px-4 py-2 hover:bg-gray-100",{"text-[rgb(98,82,254)] font-medium":m.value==="Оплачен"}])}," Оплачен ",2),t("li",{onClick:e[3]||(e[3]=s=>$("Не оплачен")),class:S(["cursor-pointer px-4 py-2 hover:bg-gray-100",{"text-[rgb(98,82,254)] font-medium":m.value==="Не оплачен"}])}," Не оплачен ",2)])):R("",!0)]),t("div",{class:"relative"},[t("button",{onClick:X,class:"filter-select w-full flex justify-between items-center"}," Очистить фильтры ")])]),t("table",fe,[e[8]||(e[8]=t("thead",{class:"bg-[#ECE9FF] text-sm font-semibold"},[t("tr",null,[t("th",{class:"px-4 py-2 w-12"},"№"),t("th",{class:"px-4 py-2"},"Студент"),t("th",{class:"px-4 py-2"},"К оплате (тг)"),t("th",{class:"px-4 py-2"},"Дата оплаты"),t("th",{class:"px-4 py-2"},"Статус"),t("th",{class:"px-4 py-2"},"Комментарий")])],-1)),t("tbody",null,[(r(!0),b(le,null,oe(g.value,(s,u)=>(r(),b("tr",{key:s.id,class:"border-t"},[t("td",ve,[t("div",me,o(u+1),1)]),t("td",be,o(s.student),1),t("td",xe,o(s.amount.toLocaleString("ru-RU")),1),t("td",ye,o(s.paymentDate),1),t("td",we,[t("span",{class:S({"status-unpaid":s.status==="Не оплачен","status-paid":s.status==="Оплачен"})},o(s.status),3)]),t("td",ge,o(s.comment),1)]))),128))])]),t("div",ke,[t("div",_e," Период "+o(H.value),1),t("div",he,[e[9]||(e[9]=t("div",null,"Общая сумма платежей",-1)),t("div",null,o(A.value.toLocaleString("ru-RU"))+" ₸",1)]),t("div",De,[e[10]||(e[10]=t("div",null,"Оплаченная сумма",-1)),t("div",null,o(B.value.toLocaleString("ru-RU"))+" ₸",1)]),t("div",Se,[e[11]||(e[11]=t("div",null,"Неоплаченная сумма",-1)),t("div",null,o(z.value.toLocaleString("ru-RU"))+" ₸",1)]),t("div",Ce,[e[12]||(e[12]=t("div",null,"Общая задолженность",-1)),t("div",null,o(z.value.toLocaleString("ru-RU"))+" ₸",1)])]),t("div",{class:"mt-4 flex justify-end"},[t("button",{onClick:W,class:"download-btn"},"Сохранить в Excel")])])}}},Le=Z(Fe,[["__scopeId","data-v-6338e619"]]);export{Le as default};
