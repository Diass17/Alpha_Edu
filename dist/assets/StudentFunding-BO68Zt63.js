import{l as V,s as P,r as v,o as z,a as A,b as B,c as g,m as I,e as u,k as c,f as t,w as Y,v as $,p as x,q as w,h as _,n as p,u as F,g as j,t as l,F as k,i as C,z as S,A as G}from"./index-BT1ZDAml.js";import{_ as H}from"./search-CKZYpkUj.js";const J={class:"p-6 font-inter"},K={class:"flex items-center justify-between mb-6"},Q={class:"search-wrapper"},W={class:"flex space-x-4 bg-[#F1EFFF] p-3 rounded-lg mb-4"},X={class:"filters-wrapper relative flex flex-wrap gap-3 mb-6"},Z={class:"relative w-56"},ee={key:0,class:"funding-dropdown absolute z-50 mt-2 w-full bg-white border border-purple-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"},te=["onClick"],ne={key:0,class:"text-[rgb(98,82,254)]"},se={class:"w-full bg-white text-left border border-purple-200 rounded-lg overflow-hidden"},oe={class:"px-4 py-2"},ae={class:"inline-block bg-[#F1ECFF] text-[#6252FE] font-semibold text-xs rounded-full w-6 h-6 text-center leading-6"},le={class:"px-4 py-2"},re={class:"px-4 py-2"},de={class:"px-4 py-2"},ue={class:"px-4 py-2"},ce={class:"px-4 py-2"},ie={class:"mt-6 w-full bg-white overflow-hidden rounded-xl border border-[#E0D7FF]"},pe={class:"w-full text-sm text-left border-collapse"},fe={class:"divide-y divide-[#E0D7FF]"},ve={class:"px-4 py-2"},ge={class:"px-4 py-2"},_e={class:"px-4 py-2"},me={class:"px-4 py-2"},ye={class:"px-4 py-2"},be={class:"bg-[#ECE9FF] font-semibold divide-x divide-[#E0D7FF]"},he={class:"px-4 py-2"},xe={class:"px-4 py-2"},we={class:"px-4 py-2"},Fe={__name:"StudentFunding",setup(ke){const m=P(),R=["TechOrda","Скидка 30%","Скидка 70%","Внутренний грант","Полная оплата"],r=v([]),i=v(!1),E=v([]),y=v("");z(async()=>{try{const s=await A.get("/api/students");document.addEventListener("click",D),E.value=s.data.map(e=>{const o=e.total_cost||0;let n=0,a="0%";e.funding_source==="TechOrda"||e.funding_source==="Внутренний грант"?(n=100,a="100%"):e.funding_source==="Скидка 70%"?(n=70,a="70%"):e.funding_source==="Скидка 30%"?(n=30,a="30%"):e.funding_source==="Полная оплата"&&(n=0,a="-");const d=Math.round(o*n/100),h=typeof e.paid_amount=="number"?e.paid_amount:o-(typeof e.amount_remaining=="number"?e.amount_remaining:d);let T=typeof e.amount_remaining=="number"?e.amount_remaining:o-d;return{name:e.full_name,funding:e.funding_source||"Не указано",percent:a,total:o.toLocaleString("ru-RU"),covered:d.toLocaleString("ru-RU"),pay:T.toLocaleString("ru-RU"),raw:{covered:d,pay:T,paid:h}}})}catch(s){console.error("Ошибка при получении данных студентов:",s)}}),B(()=>{document.removeEventListener("click",D)});const L={TechOrda:1,"Скидка 70%":2,"Скидка 30%":3,"Внутренний грант":4},f=g(()=>E.value.filter(s=>r.value.length===0||r.value.includes(s.funding)).sort((s,e)=>(L[s.funding]||99)-(L[e.funding]||99)));function U(){i.value=!i.value}function q(s){const e=r.value.indexOf(s);e===-1?r.value.push(s):r.value.splice(e,1)}const M=g(()=>{const s={};for(const e of f.value)s[e.funding]||(s[e.funding]={type:e.funding,count:0,percentList:[],covered:0,paid:0}),s[e.funding].count++,s[e.funding].percentList.push(e.percent),s[e.funding].covered+=e.raw.covered||0,s[e.funding].paid+=e.raw.paid||0;return Object.values(s).map(e=>{const o=[...new Set(e.percentList)];return{type:e.type,count:e.count,percent:o.length===1?o[0]:"-",covered:e.covered.toLocaleString("ru-RU"),paid:e.paid.toLocaleString("ru-RU")}})});function D(s){var a,d;const e=s.target;document.querySelector(".funding-dropdown"),document.querySelector(".funding-btn");const o=document.querySelector(".coverage-dropdown"),n=document.querySelector(".coverage-btn");i.value&&!((a=document.querySelector(".funding-dropdown"))!=null&&a.contains(e))&&!((d=document.querySelector(".funding-btn"))!=null&&d.contains(e))&&(i.value=!1),showCoveragePercent.value&&!(o!=null&&o.contains(e))&&!(n!=null&&n.contains(e))&&(showCoveragePercent.value=!1)}function O(){r.value=[],i.value=!1}const b=g(()=>{let s=0,e=0,o=0;for(const n of f.value)s++,e+=n.raw.covered||0,o+=n.raw.paid||0;return{count:s,covered:e.toLocaleString("ru-RU"),paid:o.toLocaleString("ru-RU")}});function N(){const s=S.json_to_sheet(f.value.map(o=>({Студент:o.name,"Тип финансирования":o.funding,"Стоимость обучения":o.total,"Сумма покрытия":o.covered,"К оплате":o.pay}))),e=S.book_new();S.book_append_sheet(e,s,"Финансирование"),G(e,"Финансирование.xlsx")}return g(()=>{const s=endDate.value?new Date(endDate.value.getFullYear(),endDate.value.getMonth(),endDate.value.getDate()+1):null;return rows.value.filter(e=>{const o=new Date(e.date.split(".").reverse().join("-")),n=(!startDate.value||o>=startDate.value)&&(!s||o<s),a=!selectedCourse.value||e.course===selectedCourse.value,d=r.value.length===0||r.value.includes(e.payment),h=e.student.toLowerCase().includes(y.value.toLowerCase());return n&&a&&d&&h})}),(s,e)=>{const o=I("router-link");return c(),u("div",J,[t("div",K,[e[2]||(e[2]=t("h2",{class:"text-2xl font-bold mb-6"},"Финансирование студентов",-1)),t("div",Q,[e[1]||(e[1]=t("img",{src:H,class:"search-icon"},null,-1)),Y(t("input",{"onUpdate:modelValue":e[0]||(e[0]=n=>y.value=n),type:"text",placeholder:"Поиск",class:"search-input"},null,512),[[$,y.value]])])]),t("div",W,[x(o,{to:"/finance/reports/total-revenue",class:p(["tab-button",{"tab-button-active":F(m).path==="/finance/reports/total-revenue"}])},{default:w(()=>e[3]||(e[3]=[_(" Общая выручка")])),_:1,__:[3]},8,["class"]),x(o,{to:"/finance/reports/debts",class:p(["tab-button",{"tab-button-active":F(m).path==="/finance/reports/debts"}])},{default:w(()=>e[4]||(e[4]=[_(" Задолженности")])),_:1,__:[4]},8,["class"]),x(o,{to:"/finance/reports/student-funding",class:p(["tab-button",{"tab-button-active":F(m).path==="/finance/reports/student-funding"}])},{default:w(()=>e[5]||(e[5]=[_(" Финансирование студентов")])),_:1,__:[5]},8,["class"])]),t("div",X,[t("div",Z,[t("button",{onClick:U,class:"filter-select w-full flex justify-between items-center funding-btn",type:"button"},[_(l(r.value.length?r.value.join(", "):"Тип финансирования")+" ",1),(c(),u("svg",{class:p(["w-4 h-4 ml-2 transform transition-transform duration-200",i.value?"rotate-180":""]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},e[6]||(e[6]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)]),2))]),i.value?(c(),u("ul",ee,[(c(),u(k,null,C(R,n=>t("li",{key:n,onClick:a=>q(n),class:"cursor-pointer px-4 py-2 hover:bg-gray-100 flex justify-between items-center"},[t("span",{class:p({"text-[rgb(98,82,254)] font-medium":r.value.includes(n)})},l(n),3),r.value.includes(n)?(c(),u("span",ne,"✔")):j("",!0)],8,te)),64))])):j("",!0)]),t("div",{class:"relative"},[t("button",{onClick:O,class:"filter-select w-full flex justify-between items-center coverage-btn",type:"button"}," Очистить фильтры ")])]),t("table",se,[e[7]||(e[7]=t("thead",{class:"bg-[#ECE9FF] text-sm font-semibold"},[t("tr",null,[t("th",{class:"px-4 py-2 w-12"},"№"),t("th",{class:"px-4 py-2"},"Студент"),t("th",{class:"px-4 py-2"},"Тип финансирования"),t("th",{class:"px-4 py-2"},"Стоимость обучения (тг)"),t("th",{class:"px-4 py-2"},"Cумма скидки (тг)"),t("th",{class:"px-4 py-2"},"К оплате (тг)")])],-1)),t("tbody",null,[(c(!0),u(k,null,C(f.value,(n,a)=>(c(),u("tr",{key:a,class:"border-t"},[t("td",oe,[t("span",ae,l(a+1),1)]),t("td",le,l(n.name),1),t("td",re,l(n.funding),1),t("td",de,l(n.total),1),t("td",ue,l(n.covered),1),t("td",ce,l(n.pay),1)]))),128))])]),t("div",ie,[t("table",pe,[e[10]||(e[10]=t("thead",null,[t("tr",{class:"bg-[#ECE9FF] font-semibold divide-x divide-[#E0D7FF]"},[t("th",{class:"px-4 py-2"},"Тип финансирования"),t("th",{class:"px-4 py-2"},"Кол-во студентов"),t("th",{class:"px-4 py-2"},"Покрытие (%)"),t("th",{class:"px-4 py-2"},"Общая сумма скидки (тг)"),t("th",{class:"px-4 py-2"},"Всего оплачено студентами (тг)")])],-1)),t("tbody",fe,[(c(!0),u(k,null,C(M.value,(n,a)=>(c(),u("tr",{key:a,class:"divide-x divide-[#E0D7FF]"},[t("td",ve,l(n.type),1),t("td",ge,l(n.count),1),t("td",_e,l(n.percent),1),t("td",me,l(n.covered),1),t("td",ye,l(n.paid),1)]))),128)),t("tr",be,[e[8]||(e[8]=t("td",{class:"px-4 py-2"},"Итого",-1)),t("td",he,l(b.value.count),1),e[9]||(e[9]=t("td",{class:"px-4 py-2"},"-",-1)),t("td",xe,l(b.value.covered),1),t("td",we,l(b.value.paid),1)])])])]),t("div",{class:"mt-4 flex justify-end"},[t("button",{onClick:N,class:"download-btn"},"Сохранить в Excel")])])}}},Ee=V(Fe,[["__scopeId","data-v-6a407908"]]);export{Ee as default};
