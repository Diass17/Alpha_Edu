import{d as ne,r,c as x,o as ae,a as z,b as i,e as t,m as w,p as P,g as k,n as _,u as j,q as ue,l as re,s as M,t as a,f as h,x as U,T as N,w as ie,v as ce,F as S,h as T,y as V,z as de,j as o,k as ve}from"./index-BRTAl4Rn.js";import{L as A}from"./vue3-datepicker-DPS-irVF.js";const fe={class:"p-6 font-inter"},pe={class:"flex space-x-4 bg-[#F1EFFF] p-3 rounded-lg mb-4"},me={class:"filters-wrapper relative flex flex-wrap gap-3 mb-6"},be={class:"relative"},ge={class:"relative"},ye={class:"relative w-48"},xe={key:0,class:"course-dropdown absolute z-50 mt-2 w-full bg-white border border-purple-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"},we=["onClick"],ke={class:"relative w-48"},_e={key:0,class:"funding-dropdown absolute z-10 w-full mt-2 bg-white border rounded-lg shadow-md"},he=["onClick"],Ce={key:0,class:"text-[rgb(98,82,254)]"},Fe={class:"w-full border bg-white border-purple-200 rounded-lg overflow-hidden text-left"},De={class:"px-4 py-2"},Re={class:"px-4 py-2"},Ee={class:"px-4 py-2"},Pe={class:"px-4 py-2"},je={class:"px-4 py-2"},Se={class:"mt-6 w-full rounded-xl overflow-hidden border border-[#E0D7FF]"},Te={class:"bg-[#ECE9FF] px-6 py-4 text-sm font-semibold text-black"},Ve={class:"bg-white px-6 py-4 text-sm flex justify-between items-center"},Le={class:"bg-[#ECE9FF] px-6 py-4 text-sm font-semibold flex justify-between items-center"},Be=ne({__name:"TotalRevenue",setup($e){const O=ue(),d=r([]),v=r(void 0),c=r(void 0),m=r(!1),b=r(!1),L=r(null),B=r(null),C=r({start:"",end:""}),f=r(!1),y=r(""),D=r(""),R=r([]),q=x(()=>Array.from(new Set(R.value.map(s=>s.course))).filter(s=>s.toLowerCase().includes(D.value.toLowerCase())));function Y(){f.value=!f.value}function I(s){y.value=s,f.value=!1}function F(s){return s.toLocaleDateString("ru-RU")}function G(s){if(m.value=!m.value,m.value){const e=s.target.getBoundingClientRect();C.value.start=`position: absolute; top: ${e.bottom+window.scrollY+5}px; left: ${e.left}px; z-index: 9999;`}}function H(s){if(b.value=!b.value,b.value){const e=s.target.getBoundingClientRect();C.value.end=`position: absolute; top: ${e.bottom+window.scrollY+5}px; left: ${e.left}px; z-index: 9999;`}}function J(){m.value=!1}function K(){b.value=!1}ae(()=>{document.addEventListener("click",W),Q()});async function Q(){try{const[s,e]=await Promise.all([z.get("/api/students"),z.get("/api/courses")]),n=e.data;R.value=s.data.map(l=>{const u=n.find(p=>p.id===l.course_id||p.name===l.subject);return{date:l.last_payment_date?new Date(l.last_payment_date).toLocaleDateString("ru-RU"):"–––",amount:(l.paid_amount||0).toLocaleString("ru-RU"),course:(u==null?void 0:u.name)||l.subject||"–––",student:l.full_name||"",payment:l.funding_source||""}})}catch(s){console.error("Ошибка при загрузке студентов или курсов:",s)}}function W(s){var u,p;const e=s.target;!((u=L.value)!=null&&u.contains(e))&&!e.closest(".start-picker-btn")&&(m.value=!1),!((p=B.value)!=null&&p.contains(e))&&!e.closest(".end-picker-btn")&&(b.value=!1);const n=document.querySelector(".course-dropdown");f.value&&n&&!n.contains(e)&&!e.closest(".filter-select")&&(f.value=!1);const l=document.querySelector(".funding-dropdown");g.value&&l&&!l.contains(e)&&!e.closest(".filter-select")&&(g.value=!1)}const X=x(()=>v.value&&c.value?`${F(v.value)} - ${F(c.value)}`:"не выбран"),E=x(()=>{const s=c.value?new Date(c.value.getFullYear(),c.value.getMonth(),c.value.getDate()+1):null;return R.value.filter(e=>{const n=new Date(e.date.split(".").reverse().join("-")),l=(!v.value||n>=v.value)&&(!s||n<s),u=!y.value||e.course===y.value,p=d.value.length===0||d.value.includes(e.payment);return l&&u&&p})}),Z=x(()=>E.value.reduce((s,e)=>{const n=parseInt(e.amount.replace(/[^\d]/g,""),10);return s+(isNaN(n)?0:n)},0)),$=x(()=>Z.value.toLocaleString("ru-RU"));function ee(){const s=V.json_to_sheet(E.value),e=V.book_new();V.book_append_sheet(e,s,"Отчёт"),de(e,"Отчёт.xlsx")}const te=["Полная оплата","TechOrda","Скидка 30%","Скидка 70%","Внутренний грант"],g=r(!1);function le(){g.value=!g.value,f.value=!1,m.value=!1,b.value=!1}function se(s){const e=d.value.indexOf(s);e===-1?d.value.push(s):d.value.splice(e,1)}function oe(){v.value=void 0,c.value=void 0,y.value="",d.value=[],f.value=!1,g.value=!1}return(s,e)=>{const n=re("router-link");return o(),i("div",fe,[e[11]||(e[11]=t("h2",{class:"text-2xl font-bold mb-6"},"Общая выручка",-1)),t("div",pe,[w(n,{to:"/finance/reports/total-revenue",class:_(["tab-button",{"tab-button-active":j(O).path==="/finance/reports/total-revenue"}])},{default:P(()=>e[3]||(e[3]=[k("Общая выручка")])),_:1,__:[3]},8,["class"]),w(n,{to:"/finance/reports/debts",class:"tab-button"},{default:P(()=>e[4]||(e[4]=[k("Задолженности")])),_:1,__:[4]}),w(n,{to:"/finance/reports/student-funding",class:"tab-button"},{default:P(()=>e[5]||(e[5]=[k("Финансирование студентов")])),_:1,__:[5]})]),t("div",me,[t("div",be,[t("button",{onClick:G,class:"filter-select w-48 start-picker-btn"},a(v.value?F(v.value):"Начало периода"),1),(o(),M(N,{to:"body"},[m.value?(o(),i("div",{key:0,class:"datepicker-popup",style:U(C.value.start),ref_key:"startPickerRef",ref:L},[w(j(A),{modelValue:v.value,"onUpdate:modelValue":[e[0]||(e[0]=l=>v.value=l),J]},null,8,["modelValue"])],4)):h("",!0)]))]),t("div",ge,[t("button",{onClick:H,class:"filter-select w-48 end-picker-btn"},a(c.value?F(c.value):"Конец периода"),1),(o(),M(N,{to:"body"},[b.value?(o(),i("div",{key:0,class:"datepicker-popup",style:U(C.value.end),ref_key:"endPickerRef",ref:B},[w(j(A),{modelValue:c.value,"onUpdate:modelValue":[e[1]||(e[1]=l=>c.value=l),K]},null,8,["modelValue"])],4)):h("",!0)]))]),t("div",ye,[t("button",{onClick:Y,class:"filter-select w-full flex justify-between items-center",type:"button"},[k(a(y.value||"Курс")+" ",1),(o(),i("svg",{class:_(["w-4 h-4 ml-2 transform transition-transform duration-200",f.value?"rotate-180":""]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},e[6]||(e[6]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)]),2))]),f.value?(o(),i("div",xe,[ie(t("input",{type:"text","onUpdate:modelValue":e[2]||(e[2]=l=>D.value=l),placeholder:"Поиск курса",class:"w-full px-3 py-2 text-sm border-b outline-none"},null,512),[[ce,D.value]]),t("ul",null,[(o(!0),i(S,null,T(q.value,(l,u)=>(o(),i("li",{key:u,onClick:p=>I(l),class:_(["cursor-pointer px-4 py-2 hover:bg-gray-100",{"text-[rgb(98,82,254)] font-medium":y.value===l}])},a(l),11,we))),128))])])):h("",!0)]),t("div",ke,[t("button",{onClick:le,class:"filter-select w-full flex justify-between items-center",type:"button"},[k(a(d.value.length?d.value.join(", "):"Тип финансирования")+" ",1),(o(),i("svg",{class:_(["w-4 h-4 ml-2 transform transition-transform duration-200",g.value?"rotate-180":""]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},e[7]||(e[7]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)]),2))]),g.value?(o(),i("ul",_e,[(o(),i(S,null,T(te,l=>t("li",{key:l,onClick:u=>se(l),class:"cursor-pointer px-4 py-2 hover:bg-gray-100 flex justify-between items-center"},[t("span",{class:_({"text-[rgb(98,82,254)] font-medium":d.value.includes(l)})},a(l),3),d.value.includes(l)?(o(),i("span",Ce,"✔")):h("",!0)],8,he)),64))])):h("",!0)]),t("div",{class:"relative"},[t("button",{onClick:oe,class:"filter-select w-full flex justify-between items-center"}," Очистить фильтры ")])]),t("table",Fe,[e[8]||(e[8]=t("thead",{class:"bg-[#ECE9FF] text-sm font-semibold"},[t("tr",null,[t("th",{class:"px-4 py-2"},"Дата"),t("th",{class:"px-4 py-2"},"Оплачено (тг)"),t("th",{class:"px-4 py-2"},"Курс"),t("th",{class:"px-4 py-2"},"Студент"),t("th",{class:"px-4 py-2"},"Оплата")])],-1)),t("tbody",null,[(o(!0),i(S,null,T(E.value,(l,u)=>(o(),i("tr",{class:"border-t",key:u},[t("td",De,a(l.date),1),t("td",Re,a(l.amount),1),t("td",Ee,a(l.course),1),t("td",Pe,a(l.student),1),t("td",je,a(l.payment),1)]))),128))])]),t("div",Se,[t("div",Te,"Период "+a(X.value),1),t("div",Ve,[e[9]||(e[9]=t("div",null,"Выручка",-1)),t("div",null,a($.value)+" тг",1)]),t("div",Le,[e[10]||(e[10]=t("div",null,"Общая выручка",-1)),t("div",null,a($.value)+" тг",1)])]),t("div",{class:"mt-4 flex justify-end"},[t("button",{onClick:ee,class:"download-btn"},"Сохранить в Excel")])])}}}),Ue=ve(Be,[["__scopeId","data-v-08e2c7f5"]]);export{Ue as default};
