import{_ as oe,u as ne,r as a,c as x,o as ae,a as U,k as re,b as r,d as o,e as t,l as y,m as P,h as k,n as w,p as S,q as z,t as n,f as C,s as M,T as N,w as ue,v as ie,F as T,i as V,x as L,y as de}from"./index-PuXEcVkP.js";import{L as A}from"./vue3-datepicker-CYXaWZ-2.js";const ce={class:"p-6 font-inter"},pe={class:"flex space-x-4 bg-[#F1EFFF] p-3 rounded-lg mb-4"},ve={class:"filters-wrapper relative flex flex-wrap gap-3 mb-6"},fe={class:"relative"},me={class:"relative"},be={class:"relative w-48"},ge={key:0,class:"absolute z-50 mt-2 w-full bg-white border border-purple-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"},xe=["onClick"],ye={class:"relative w-48"},ke={key:0,class:"absolute z-10 w-full mt-2 bg-white border rounded-lg shadow-md"},we=["onClick"],_e={class:"w-full border bg-white border-purple-200 rounded-lg overflow-hidden text-left"},he={class:"px-4 py-2"},Ce={class:"px-4 py-2"},Fe={class:"px-4 py-2"},Re={class:"px-4 py-2"},Ee={class:"px-4 py-2"},De={class:"mt-6 w-full rounded-xl overflow-hidden border border-[#E0D7FF]"},Pe={class:"bg-[#ECE9FF] px-6 py-4 text-sm font-semibold text-black"},Se={class:"bg-white px-6 py-4 text-sm flex justify-between items-center"},Te={class:"bg-[#ECE9FF] px-6 py-4 text-sm font-semibold flex justify-between items-center"},Ve={__name:"TotalRevenue",setup(Le){const I=ne(),d=a(null),c=a(null),p=a(!1),v=a(!1),j=a(null),B=a(null),_=a({start:"",end:""}),f=a(!1),m=a(""),F=a(""),R=a([]),O=x(()=>{const s=new Set(R.value.map(e=>e.course));return Array.from(s).filter(e=>e.toLowerCase().includes(F.value.toLowerCase()))});function Y(){f.value=!f.value}function q(s){m.value=s,f.value=!1}function h(s){return new Date(s).toLocaleDateString("ru-RU")}function G(s){p.value=!p.value,p.value&&(_.value.start=`position: absolute; top: ${s.target.getBoundingClientRect().bottom+window.scrollY+5}px; left: ${s.target.getBoundingClientRect().left}px; z-index: 9999;`)}function H(s){v.value=!v.value,v.value&&(_.value.end=`position: absolute; top: ${s.target.getBoundingClientRect().bottom+window.scrollY+5}px; left: ${s.target.getBoundingClientRect().left}px; z-index: 9999;`)}function J(){p.value=!1}function K(){v.value=!1}ae(()=>{document.addEventListener("click",W),Q()});async function Q(){try{const[s,e]=await Promise.all([U.get("/api/students"),U.get("/api/courses")]),u=e.data;R.value=s.data.map(l=>{const i=u.find(D=>D.id===l.course_id||D.name===l.subject);return{date:new Date().toLocaleDateString("ru-RU"),amount:(l.paid_amount||0).toLocaleString("ru-RU"),course:(i==null?void 0:i.name)||l.subject||"–––",student:l.full_name||"",payment:l.funding_source||""}})}catch(s){console.error("Ошибка при загрузке студентов или курсов:",s)}}function W(s){var e,u;!((e=j.value)!=null&&e.contains(s.target))&&!s.target.closest(".start-picker-btn")&&(p.value=!1),!((u=B.value)!=null&&u.contains(s.target))&&!s.target.closest(".end-picker-btn")&&(v.value=!1)}const X=x(()=>d.value&&c.value?`${h(d.value)} - ${h(c.value)}`:"не выбран"),E=x(()=>R.value.filter(s=>{const e=new Date(s.date.split(".").reverse().join("-")),u=(!d.value||e>=d.value)&&(!c.value||e<=c.value),l=!m.value||s.course===m.value,i=!b.value||s.payment===b.value;return u&&l&&i})),Z=x(()=>E.value.reduce((s,e)=>s+parseInt(e.amount.replace(/[^\d]/g,""))||0,0)),$=x(()=>Z.value.toLocaleString("ru-RU"));function ee(){const s=L.json_to_sheet(E.value),e=L.book_new();L.book_append_sheet(e,s,"Отчёт"),de(e,"Отчёт.xlsx")}const te=["TechOrda","Скидка 30%","Скидка 70%","Внутренний грант"],b=a(""),g=a(!1);function se(){g.value=!g.value,f.value=!1,p.value=!1,v.value=!1}function le(s){b.value=s,g.value=!1}return(s,e)=>{const u=re("router-link");return o(),r("div",ce,[e[11]||(e[11]=t("h2",{class:"text-2xl font-bold mb-6"},"Общая выручка",-1)),t("div",pe,[y(u,{to:"/finance/reports/total-revenue",class:w(["tab-button",{"tab-button-active":S(I).path==="/finance/reports/total-revenue"}])},{default:P(()=>e[3]||(e[3]=[k("Общая выручка")])),_:1,__:[3]},8,["class"]),y(u,{to:"/finance/reports/debts",class:"tab-button"},{default:P(()=>e[4]||(e[4]=[k("Задолженности")])),_:1,__:[4]}),y(u,{to:"/finance/reports/student-funding",class:"tab-button"},{default:P(()=>e[5]||(e[5]=[k("Финансирование студентов")])),_:1,__:[5]})]),t("div",ve,[t("div",fe,[t("button",{onClick:G,class:"filter-select w-48 start-picker-btn"},n(d.value?h(d.value):"Начало периода"),1),(o(),z(N,{to:"body"},[p.value?(o(),r("div",{key:0,class:"datepicker-popup",style:M(_.value.start),ref_key:"startPickerRef",ref:j},[y(S(A),{modelValue:d.value,"onUpdate:modelValue":[e[0]||(e[0]=l=>d.value=l),J]},null,8,["modelValue"])],4)):C("",!0)]))]),t("div",me,[t("button",{onClick:H,class:"filter-select w-48 end-picker-btn"},n(c.value?h(c.value):"Конец периода"),1),(o(),z(N,{to:"body"},[v.value?(o(),r("div",{key:0,class:"datepicker-popup",style:M(_.value.end),ref_key:"endPickerRef",ref:B},[y(S(A),{modelValue:c.value,"onUpdate:modelValue":[e[1]||(e[1]=l=>c.value=l),K]},null,8,["modelValue"])],4)):C("",!0)]))]),t("div",be,[t("button",{onClick:Y,class:"filter-select w-full flex justify-between items-center",type:"button"},[k(n(m.value||"Курс")+" ",1),(o(),r("svg",{class:w(["w-4 h-4 ml-2 transform transition-transform duration-200",f.value?"rotate-180":""]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},e[6]||(e[6]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)]),2))]),f.value?(o(),r("div",ge,[ue(t("input",{type:"text","onUpdate:modelValue":e[2]||(e[2]=l=>F.value=l),placeholder:"Поиск курса",class:"w-full px-3 py-2 text-sm border-b outline-none"},null,512),[[ie,F.value]]),t("ul",null,[(o(!0),r(T,null,V(O.value,(l,i)=>(o(),r("li",{key:i,onClick:D=>q(l),class:w(["cursor-pointer px-4 py-2 hover:bg-gray-100",{"text-[rgb(98,82,254)] font-medium":m.value===l}])},n(l),11,xe))),128))])])):C("",!0)]),t("div",ye,[t("button",{onClick:se,class:"filter-select w-full flex justify-between items-center",type:"button"},[k(n(b.value||"Тип финансирования")+" ",1),(o(),r("svg",{class:w(["w-4 h-4 ml-2 transform transition-transform duration-200",g.value?"rotate-180":""]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},e[7]||(e[7]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)]),2))]),g.value?(o(),r("ul",ke,[(o(),r(T,null,V(te,l=>t("li",{key:l,onClick:i=>le(l),class:w(["cursor-pointer px-4 py-2 hover:bg-gray-100",{"text-[rgb(98,82,254)] font-medium":b.value===l}])},n(l),11,we)),64))])):C("",!0)])]),t("table",_e,[e[8]||(e[8]=t("thead",{class:"bg-[#ECE9FF] text-sm font-semibold"},[t("tr",null,[t("th",{class:"px-4 py-2"},"Дата"),t("th",{class:"px-4 py-2"},"Сумма (тг)"),t("th",{class:"px-4 py-2"},"Курс"),t("th",{class:"px-4 py-2"},"Студент"),t("th",{class:"px-4 py-2"},"Оплата")])],-1)),t("tbody",null,[(o(!0),r(T,null,V(E.value,(l,i)=>(o(),r("tr",{class:"border-t",key:i},[t("td",he,n(l.date),1),t("td",Ce,n(l.amount),1),t("td",Fe,n(l.course),1),t("td",Re,n(l.student),1),t("td",Ee,n(l.payment),1)]))),128))])]),t("div",De,[t("div",Pe,"Период "+n(X.value),1),t("div",Se,[e[9]||(e[9]=t("div",null,"Выручка",-1)),t("div",null,n($.value)+" тг",1)]),t("div",Te,[e[10]||(e[10]=t("div",null,"Общая выручка",-1)),t("div",null,n($.value)+" тг",1)])]),t("div",{class:"mt-4 flex justify-end"},[t("button",{onClick:ee,class:"download-btn"},"Сохранить в Excel")])])}}},$e=oe(Ve,[["__scopeId","data-v-d1051eca"]]);export{$e as default};
