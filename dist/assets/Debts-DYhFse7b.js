import{k as ee,r as n,o as te,a as N,A as se,c as w,l as le,b,j as i,e as t,m as g,p as C,g as D,s as T,t as o,f as F,x as I,u as M,T as Y,n as S,F as oe,h as ae,y as R,z as ne}from"./index-D1yyfS71.js";import{L as q}from"./vue3-datepicker-BHtIG-If.js";const re={class:"p-6 font-inter"},ie={class:"flex space-x-4 bg-[#F1EFFF] p-3 rounded-lg mb-4"},ue={class:"filters-wrapper relative flex flex-wrap gap-3 mb-6"},de={class:"relative"},ce={class:"relative"},pe={class:"relative w-40 status-dropdown"},fe={key:0,class:"absolute z-50 mt-2 w-full bg-white border border-purple-200 rounded-lg shadow-lg overflow-hidden"},ve={class:"w-full bg-white border border-purple-200 rounded-lg overflow-hidden text-left mt-6"},me={class:"px-4 py-2"},be={class:"w-6 h-6 rounded-md bg-[#F1ECFF] text-[rgb(98,82,254)] text-xs font-semibold flex items-center justify-center"},xe={class:"px-4 py-2"},ye={class:"px-4 py-2"},we={class:"px-4 py-2"},ge={class:"px-4 py-2"},_e={class:"px-4 py-2"},ke={class:"mt-6 w-full rounded-xl overflow-hidden border border-[#E0D7FF]"},he={class:"bg-[#ECE9FF] px-6 py-4 text-sm font-semibold text-black"},De={class:"bg-white px-6 py-4 text-sm flex justify-between border-b border-gray-200/60"},Se={class:"bg-white px-6 py-4 text-sm flex justify-between border-b border-gray-200/60"},Ce={class:"bg-white px-6 py-4 text-sm flex justify-between border-b border-gray-200/60"},Fe={class:"bg-[#ECE9FF] px-6 py-4 text-sm font-semibold flex justify-between"},Re={__name:"Debts",setup(Ee){const c=n(null),p=n(null),f=n(!1),v=n(!1),_=n({start:"",end:""}),E=n(null),P=n(null),U=n([]);te(async()=>{document.addEventListener("click",j);try{const e=(await N.get("http://localhost:3000/reports/debts")).data,a=await Promise.all(e.map(async s=>{if(!s||!s.id)return console.warn("Пропущен студент из-за отсутствия id:",s),null;let d="Не оплачен",y="-";(s.discount_percent===100||s.amount_remaining===0)&&(d="Оплачен");try{const h=(await N.get(`http://localhost:3000/api/students/${s.id}/payment-schedule`)).data.paymentSchedule;if(Array.isArray(h)&&h.length>0){h.every(r=>r.paid)&&(d="Оплачен");const A=h.filter(r=>r.date).sort((r,Z)=>new Date(r.date)-new Date(Z.date)),B=A.find(r=>!r.paid),z=[...A].reverse().find(r=>r.paid);B?y=new Date(B.date).toLocaleDateString("ru-RU"):z&&(y=new Date(z.date).toLocaleDateString("ru-RU"))}else s.created_at&&(y=new Date(s.created_at).toLocaleDateString("ru-RU"))}catch($){console.warn(`Не удалось получить график для студента ID ${s.id}`,$),s.created_at&&(y=new Date(s.created_at).toLocaleDateString("ru-RU"))}return{id:s.id,student:s.full_name,amount:s.amount_remaining,paidAmount:s.paid_amount||0,paymentDate:y,status:d,comment:""}}));U.value=a.filter(Boolean)}catch(l){console.error("Ошибка при загрузке задолженностей:",l)}}),se(()=>{document.removeEventListener("click",j)});const x=w(()=>{let l=[...U.value];return m.value&&(l=l.filter(e=>e.status===m.value)),l.sort((e,a)=>e.id-a.id)});function L(l){m.value=l,u.value=!1}const O=w(()=>x.value.reduce((l,e)=>l+(e.amount||0)+(e.paidAmount||0),0)),G=w(()=>x.value.reduce((l,e)=>l+(e.paidAmount||0),0)),V=w(()=>x.value.reduce((l,e)=>l+(e.amount||0),0)),H=w(()=>c.value&&p.value?`${k(c.value)} - ${k(p.value)}`:"не выбран"),k=l=>new Date(l).toLocaleDateString("ru-RU");function J(l){if(f.value=!f.value,f.value){v.value=!1;const e=l.target.getBoundingClientRect();_.value.start=`position: absolute; top: ${e.bottom+window.scrollY+5}px; left: ${e.left}px; z-index: 9999;`}}function K(l){if(v.value=!v.value,v.value){f.value=!1;const e=l.target.getBoundingClientRect();_.value.end=`position: absolute; top: ${e.bottom+window.scrollY+5}px; left: ${e.left}px; z-index: 9999;`}}function Q(){u.value=!u.value,f.value=!1,v.value=!1}const W=()=>{const l=x.value.map(s=>({Студент:s.student,Сумма:s.amount,Статус:s.status,Комментарий:s.comment})),e=R.json_to_sheet(l),a=R.book_new();R.book_append_sheet(a,e,"Задолженности"),ne(a,"Задолженности.xlsx")},m=n(""),u=n(!1);function X(){c.value=null,p.value=null,m.value="",u.value=!1}function j(l){var s,d;const e=l.target;!((s=E.value)!=null&&s.contains(e))&&!e.closest(".start-picker-btn")&&(f.value=!1),!((d=P.value)!=null&&d.contains(e))&&!e.closest(".end-picker-btn")&&(v.value=!1);const a=document.querySelector(".status-dropdown");u.value&&a&&!a.contains(e)&&!e.closest(".filter-select")&&(u.value=!1)}return(l,e)=>{const a=le("router-link");return i(),b("div",re,[e[13]||(e[13]=t("h2",{class:"text-2xl font-bold mb-6"},"Задолженности",-1)),t("div",ie,[g(a,{to:"/finance/reports/total-revenue",class:"tab-button"},{default:C(()=>e[4]||(e[4]=[D("Общая выручка")])),_:1,__:[4]}),g(a,{to:"/finance/reports/debts",class:"tab-button-active"},{default:C(()=>e[5]||(e[5]=[D("Задолженности")])),_:1,__:[5]}),g(a,{to:"/finance/reports/student-funding",class:"tab-button"},{default:C(()=>e[6]||(e[6]=[D("Финансирование студентов")])),_:1,__:[6]})]),t("div",ue,[t("div",de,[t("button",{onClick:J,class:"filter-select w-48 start-picker-btn"},o(c.value?k(c.value):"Начало периода"),1),(i(),T(Y,{to:"body"},[f.value?(i(),b("div",{key:0,class:"datepicker-popup",style:I(_.value.start),ref_key:"startPickerRef",ref:E},[g(M(q),{modelValue:c.value,"onUpdate:modelValue":[e[0]||(e[0]=s=>c.value=s),l.closeStartPicker]},null,8,["modelValue","onUpdate:modelValue"])],4)):F("",!0)]))]),t("div",ce,[t("button",{onClick:K,class:"filter-select w-48 end-picker-btn"},o(p.value?k(p.value):"Конец периода"),1),(i(),T(Y,{to:"body"},[v.value?(i(),b("div",{key:0,class:"datepicker-popup",style:I(_.value.end),ref_key:"endPickerRef",ref:P},[g(M(q),{modelValue:p.value,"onUpdate:modelValue":[e[1]||(e[1]=s=>p.value=s),l.closeEndPicker]},null,8,["modelValue","onUpdate:modelValue"])],4)):F("",!0)]))]),t("div",pe,[t("button",{onClick:Q,class:"filter-select w-full flex justify-between items-center",type:"button"},[D(o(m.value||"Статус")+" ",1),(i(),b("svg",{class:S(["w-4 h-4 ml-2 transform transition-transform duration-200",u.value?"rotate-180":""]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},e[7]||(e[7]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)]),2))]),u.value?(i(),b("ul",fe,[t("li",{onClick:e[2]||(e[2]=s=>L("Оплачен")),class:S(["cursor-pointer px-4 py-2 hover:bg-gray-100",{"text-[rgb(98,82,254)] font-medium":m.value==="Оплачен"}])}," Оплачен ",2),t("li",{onClick:e[3]||(e[3]=s=>L("Не оплачен")),class:S(["cursor-pointer px-4 py-2 hover:bg-gray-100",{"text-[rgb(98,82,254)] font-medium":m.value==="Не оплачен"}])}," Не оплачен ",2)])):F("",!0)]),t("div",{class:"relative"},[t("button",{onClick:X,class:"filter-select w-full flex justify-between items-center"}," Очистить фильтры ")])]),t("table",ve,[e[8]||(e[8]=t("thead",{class:"bg-[#ECE9FF] text-sm font-semibold"},[t("tr",null,[t("th",{class:"px-4 py-2 w-12"},"№"),t("th",{class:"px-4 py-2"},"Студент"),t("th",{class:"px-4 py-2"},"К оплате (тг)"),t("th",{class:"px-4 py-2"},"Дата оплаты"),t("th",{class:"px-4 py-2"},"Статус"),t("th",{class:"px-4 py-2"},"Комментарий")])],-1)),t("tbody",null,[(i(!0),b(oe,null,ae(x.value,(s,d)=>(i(),b("tr",{key:s.id,class:"border-t"},[t("td",me,[t("div",be,o(d+1),1)]),t("td",xe,o(s.student),1),t("td",ye,o(s.amount.toLocaleString("ru-RU")),1),t("td",we,o(s.paymentDate),1),t("td",ge,[t("span",{class:S({"status-unpaid":s.status==="Не оплачен","status-paid":s.status==="Оплачен"})},o(s.status),3)]),t("td",_e,o(s.comment),1)]))),128))])]),t("div",ke,[t("div",he," Период "+o(H.value),1),t("div",De,[e[9]||(e[9]=t("div",null,"Общая сумма платежей",-1)),t("div",null,o(O.value.toLocaleString("ru-RU"))+" ₸",1)]),t("div",Se,[e[10]||(e[10]=t("div",null,"Оплаченная сумма",-1)),t("div",null,o(G.value.toLocaleString("ru-RU"))+" ₸",1)]),t("div",Ce,[e[11]||(e[11]=t("div",null,"Неоплаченная сумма",-1)),t("div",null,o(V.value.toLocaleString("ru-RU"))+" ₸",1)]),t("div",Fe,[e[12]||(e[12]=t("div",null,"Общая задолженность",-1)),t("div",null,o(V.value.toLocaleString("ru-RU"))+" ₸",1)])]),t("div",{class:"mt-4 flex justify-end"},[t("button",{onClick:W,class:"download-btn"},"Сохранить в Excel")])])}}},Ve=ee(Re,[["__scopeId","data-v-55467f10"]]);export{Ve as default};
